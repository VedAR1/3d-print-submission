<!DOCTYPE html>
<html>
<head>
  <title>3D Print Submission</title>
  <style>
    body { font-family: Arial; max-width: 700px; margin: auto; padding: 20px; }
    label { display:block; margin-top:15px; font-weight: bold; }
    input, select, textarea { width: 100%; padding: 8px; margin-top: 5px; box-sizing: border-box; }
    small { color: #555; font-weight: normal; }
    button { background: #007bff; color: white; padding: 10px 20px; border: none; cursor: pointer; margin-top: 20px; width: 100%; font-size: 16px; }
    button:hover { background: #0056b3; }
    #dimensions { margin-top: 15px; padding: 15px; border: 1px solid #ddd; background: #f9f9f9; display: none; }
  </style>
</head>
<body>

<h2>3D Print Submission</h2>

<label>Name</label>
<input id="name" required placeholder="Your Full Name">

<label>Student ID</label>
<input id="studentId" required placeholder="000000">

<label>3D File (STL or OBJ only)</label>
<input type="file" id="fileInput" accept=".stl,.obj" required>

<div id="dimensions"></div>

<hr style="margin-top:20px">

<h3>Print Settings</h3>

<label>Material <small>(PLA, PETG, etc.)</small></label>
<input id="material" value="PLA">

<label>Infill % <small>(How solid the part is inside)</small></label>
<input id="infill" type="number" value="15">

<label>Layer Height (mm) <small>(0.2 = standard quality)</small></label>
<input id="layerHeight" value="0.2">

<label>Supports <small>(Enable if your model has overhangs)</small></label>
<select id="supports">
  <option>No</option>
  <option>Yes</option>
</select>

<label>Brim <small>(Improves bed adhesion)</small></label>
<select id="brim">
  <option>No</option>
  <option>Yes</option>
</select>

<label>Notes (optional)</label>
<textarea id="notes" rows="3"></textarea>

<button onclick="submitForm()">Submit Print Request</button>

<script>
let fileBase64 = "";
let dimX = 0, dimY = 0, dimZ = 0;

const fileInput = document.getElementById("fileInput");
const dimensionsDiv = document.getElementById("dimensions");

fileInput.addEventListener("change", handleFile);

async function handleFile(e) {
  const file = e.target.files[0];
  if (!file) return;

  const ext = file.name.split('.').pop().toLowerCase();
  if (!["stl", "obj"].includes(ext)) {
    alert("Only STL and OBJ files are supported.");
    fileInput.value = "";
    return;
  }

  // Convert to base64 for upload
  const reader = new FileReader();
  reader.onload = function(event) {
    fileBase64 = event.target.result.split(",")[1];
  };
  reader.readAsDataURL(file);

  try {
    if (ext === "stl") {
      const buffer = await file.arrayBuffer();
      parseSTL(buffer);
    } else {
      const text = await file.text();
      parseOBJ(text);
    }

    dimensionsDiv.style.display = "block";
    dimensionsDiv.innerHTML = `
      <b>Detected Dimensions</b><br>
      X: ${dimX} mm | Y: ${dimY} mm | Z: ${dimZ} mm<br>
      <small style="color:red">Verify these match your slicer before submitting.</small>
    `;

  } catch (err) {
    console.error(err);
    alert("Error reading file dimensions. Please try another file.");
  }
}

/* Built-in STL Parser (No library needed) */
function parseSTL(buffer) {
  const view = new DataView(buffer);
  let isBinary = true;
  
  // Check if Binary or ASCII
  for (let i = 0; i < 80; i++) {
    if (view.getUint8(i) === 0) { isBinary = true; break; }
    if (i === 79) isBinary = false;
  }

  let minX = Infinity, minY = Infinity, minZ = Infinity;
  let maxX = -Infinity, maxY = -Infinity, maxZ = -Infinity;

  if (isBinary) {
    const count = view.getUint32(84, true);
    for (let i = 0; i < count; i++) {
      let offset = 88 + (i * 50) + 12; // Skip header, count, and normals
      for (let v = 0; v < 3; v++) {
        let x = view.getFloat32(offset, true);
        let y = view.getFloat32(offset + 4, true);
        let z = view.getFloat32(offset + 8, true);
        minX = Math.min(minX, x); maxX = Math.max(maxX, x);
        minY = Math.min(minY, y); maxY = Math.max(maxY, y);
        minZ = Math.min(minZ, z); maxZ = Math.max(maxZ, z);
        offset += 12;
      }
    }
  } else {
    const text = new TextDecoder().decode(buffer);
    const lines = text.split("\n");
    lines.forEach(line => {
      if (line.trim().startsWith("vertex")) {
        const parts = line.trim().split(/\s+/);
        const x = parseFloat(parts[1]), y = parseFloat(parts[2]), z = parseFloat(parts[3]);
        minX = Math.min(minX, x); maxX = Math.max(maxX, x);
        minY = Math.min(minY, y); maxY = Math.max(maxY, y);
        minZ = Math.min(minZ, z); maxZ = Math.max(maxZ, z);
      }
    });
  }

  dimX = (maxX - minX).toFixed(2);
  dimY = (maxY - minY).toFixed(2);
  dimZ = (maxZ - minZ).toFixed(2);
}

function parseOBJ(text) {
  const lines = text.split("\n");
  let minX = Infinity, minY = Infinity, minZ = Infinity;
  let maxX = -Infinity, maxY = -Infinity, maxZ = -Infinity;

  lines.forEach(line => {
    if (line.trim().startsWith("v ")) {
      const parts = line.trim().split(/\s+/);
      const x = parseFloat(parts[1]), y = parseFloat(parts[2]), z = parseFloat(parts[3]);
      minX = Math.min(minX, x); maxX = Math.max(maxX, x);
      minY = Math.min(minY, y); maxY = Math.max(maxY, y);
      minZ = Math.min(minZ, z); maxZ = Math.max(maxZ, z);
    }
  });

  dimX = (maxX - minX).toFixed(2);
  dimY = (maxY - minY).toFixed(2);
  dimZ = (maxZ - minZ).toFixed(2);
}

function submitForm() {
  const btn = document.querySelector("button");
  if (!dimX || dimX == 0) { alert("Please upload a valid 3D file."); return; }
  
  btn.disabled = true;
  btn.innerText = "Uploading...";

  const data = {
    name: document.getElementById("name").value,
    studentId: document.getElementById("studentId").value,
    fileName: fileInput.files[0].name,
    fileData: fileBase64,
    mimeType: fileInput.files[0].type,
    dimX, dimY, dimZ,
    material: document.getElementById("material").value,
    infill: document.getElementById("infill").value,
    layerHeight: document.getElementById("layerHeight").value,
    supports: document.getElementById("supports").value,
    brim: document.getElementById("brim").value,
    notes: document.getElementById("notes").value
  };

  fetch("https://script.google.com/macros/s/AKfycbzrBniPiXCD9yEZlH4s9TjqGcN2UMjGxPhipH98VjVPslUPJvrP37neFRwMAfzVwv4k/exec", {
    method: "POST",
    body: JSON.stringify(data)
  })
  .then(res => res.json())
  .then(res => {
    if (res.status === "success") {
      alert("Submission successful!");
      location.reload();
    } else {
      alert("Error: " + res.message);
      btn.disabled = false;
      btn.innerText = "Submit Print Request";
    }
  })
  .catch(err => {
    alert("Submission failed. Check your internet connection.");
    btn.disabled = false;
    btn.innerText = "Submit Print Request";
  });
}
</script>

</body>
</html>
