<!DOCTYPE html>
<html>
<head>
  <title>3D Print Submission</title>
  <style>
    body { font-family: Arial; max-width: 700px; margin: auto; }
    label { display:block; margin-top:10px; }
    small { color: #555; }
  </style>
</head>
<body>

<h2>3D Print Submission</h2>

<label>Name</label>
<input id="name" required>

<label>Student ID</label>
<input id="studentId" required>

<label>3D File (STL or OBJ only)</label>
<input type="file" id="fileInput" accept=".stl,.obj" required>

<div id="dimensions"></div>

<h3>Print Settings</h3>

<label>Material <small>(PLA, PETG, etc.)</small></label>
<input id="material">

<label>Infill % <small>(How solid the part is inside)</small></label>
<input id="infill" type="number" value="15">

<label>Layer Height (mm) <small>(0.2 = standard quality)</small></label>
<input id="layerHeight" value="0.2">

<label>Supports <small>(Enable if your model has overhangs)</small></label>
<select id="supports">
  <option>No</option>
  <option>Yes</option>
</select>

<label>Brim <small>(Improves bed adhesion)</small></label>
<select id="brim">
  <option>No</option>
  <option>Yes</option>
</select>

<label>Notes (optional)</label>
<textarea id="notes"></textarea>

<br><br>
<button onclick="submitForm()">Submit</button>

<script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.158.0/examples/js/loaders/STLLoader.js"></script>
<script src="https://unpkg.com/three@0.158.0/examples/js/loaders/OBJLoader.js"></script>

<script>
let fileBase64 = "";
let dimX = 0, dimY = 0, dimZ = 0;

const fileInput = document.getElementById("fileInput");
const dimensionsDiv = document.getElementById("dimensions");

fileInput.addEventListener("change", handleFile);

function handleFile(e) {
  const file = e.target.files[0];
  if (!file) return;

  const ext = file.name.split('.').pop().toLowerCase();

  if (!["stl", "obj"].includes(ext)) {
    alert("Only STL and OBJ files are supported.");
    fileInput.value = "";
    return;
  }

  // Base64 for upload
  const base64Reader = new FileReader();
  base64Reader.onload = function(event) {
    fileBase64 = event.target.result.split(",")[1];
  };
  base64Reader.readAsDataURL(file);

  // Dimension calculation
  const reader = new FileReader();

  reader.onload = function(event) {
    let object;

    if (ext === "stl") {
      const loader = new THREE.STLLoader();
      const geometry = loader.parse(event.target.result);
      object = new THREE.Mesh(geometry);
    }

    if (ext === "obj") {
      const loader = new THREE.OBJLoader();
      object = loader.parse(event.target.result);
    }

    const box = new THREE.Box3().setFromObject(object);

    dimX = (box.max.x - box.min.x).toFixed(2);
    dimY = (box.max.y - box.min.y).toFixed(2);
    dimZ = (box.max.z - box.min.z).toFixed(2);

    dimensionsDiv.innerHTML = `
      <div style="margin-top:10px; padding:10px; border:1px solid #ccc;">
        <b>Detected Dimensions (mm)</b><br>
        X: ${dimX} mm<br>
        Y: ${dimY} mm<br>
        Z: ${dimZ} mm<br><br>
        <b>IMPORTANT:</b> Verify these are correct before submitting.
      </div>
    `;
  };

  if (ext === "stl") {
    reader.readAsArrayBuffer(file);
  } else {
    reader.readAsText(file);
  }
}

function submitForm() {
  if (!dimX || !dimY || !dimZ) {
    alert("Dimensions not detected. Please upload a valid STL or OBJ file.");
    return;
  }

  const data = {
    name: document.getElementById("name").value,
    studentId: document.getElementById("studentId").value,
    fileName: fileInput.files[0].name,
    fileData: fileBase64,
    mimeType: fileInput.files[0].type,
    dimX: dimX,
    dimY: dimY,
    dimZ: dimZ,
    material: document.getElementById("material").value,
    infill: document.getElementById("infill").value,
    layerHeight: document.getElementById("layerHeight").value,
    supports: document.getElementById("supports").value,
    brim: document.getElementById("brim").value,
    notes: document.getElementById("notes").value
  };

  fetch("PASTE_YOUR_APPS_SCRIPT_URL_HERE", {
    method: "POST",
    body: JSON.stringify(data)
  })
  .then(res => res.json())
  .then(res => {
    if (res.status === "success") {
      alert("Submission successful.");
      location.reload();
    } else {
      alert("Error: " + res.message);
    }
  })
  .catch(err => {
    alert("Submission failed: " + err);
  });
}
</script>


</body>
</html>
